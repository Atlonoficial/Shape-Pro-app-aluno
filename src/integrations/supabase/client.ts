// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { Capacitor } from '@capacitor/core';
import { capacitorStorage } from '@/lib/capacitorStorage';
import { logger } from '@/lib/logger';

const SUPABASE_URL = "https://bqbopkqzkavhmenjlhab.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYm9wa3F6a2F2aG1lbmpsaGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MjEwMTQsImV4cCI6MjA3MDQ5NzAxNH0.AeqAVWHVqyAn7wxNvHeuQFkJREHUTB9fZP22qpv73d0";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// ✅ BUILD 28: Usar método correto para detectar plataforma nativa
const isNativePlatform = Capacitor.isNativePlatform();

// ✅ FASE 1: Lazy initialization - client só é criado quando requisitado
let _supabaseInstance: ReturnType<typeof createClient<Database>> | null = null;

export const getSupabase = () => {
  if (!_supabaseInstance) {
    // ✅ BUILD 51: Logging detalhado incluindo fallback mode
    const usingFallback = isNativePlatform && !capacitorStorage.initialized;
    
    logger.info('Supabase Client', 'Creating client instance', {
      isNativePlatform,
      storageInitialized: isNativePlatform ? capacitorStorage.initialized : 'N/A (web)',
      fallbackMode: usingFallback,
      timestamp: Date.now()
    });
    
    // ✅ BUILD 51: SEMPRE permitir criação (usar localStorage como fallback)
    if (usingFallback) {
      logger.warn('Supabase Client', '⚠️ Using localStorage fallback (storage not ready)', {
        hint: 'Storage will be migrated in background'
      });
    }
    
    // ✅ BUILD 51: Decidir storage baseado na disponibilidade
    const storage = (isNativePlatform && capacitorStorage.initialized) 
      ? capacitorStorage 
      : localStorage;
    
    _supabaseInstance = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        storage, // ✅ localStorage ou capacitorStorage (o que estiver pronto)
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
        flowType: 'pkce',
      },
      realtime: {
        params: {
          eventsPerSecond: 10,
        },
        timeout: isNativePlatform ? 15000 : 10000,
        heartbeatIntervalMs: 30000,
      },
      global: {
        headers: {
          'X-Client-Info': 'shape-pro-mobile/1.0',
          'X-Platform': isNativePlatform ? 'capacitor' : 'web',
        },
      },
    });
    
    logger.info('Supabase Client', 'Client created successfully');
  }
  
  return _supabaseInstance;
};

// ✅ BUILD 51: Proxy SEM guard (permitir sempre, usar localStorage fallback)
export const supabase = new Proxy({} as ReturnType<typeof createClient<Database>>, {
  get(target, prop) {
    // ✅ BUILD 51: NUNCA bloquear - getSupabase() decidirá o storage
    const client = getSupabase();
    return client[prop as keyof ReturnType<typeof createClient<Database>>];
  }
});

// Export da chave pública para uso direto em fetch
export const SUPABASE_KEY = SUPABASE_PUBLISHABLE_KEY;