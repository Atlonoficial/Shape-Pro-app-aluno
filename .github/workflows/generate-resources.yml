name: Generate Mobile Resources

on:
  # Permite execuÃ§Ã£o manual via GitHub UI
  workflow_dispatch:
  
  # Auto-executa quando splash screens sÃ£o atualizados
  push:
    paths:
      - 'public/splash-source-*.png'
      - 'public/icon-source.png'
    branches:
      - main

jobs:
  generate:
    name: Generate Android & iOS Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npm install -g cordova-res

      - name: ğŸ“ Setup resources directory
        run: |
          mkdir -p resources/ios
          mkdir -p resources/android

      - name: ğŸ–¼ï¸ Copy source images
        run: |
          cp public/splash-source-black.png resources/splash.png
          cp public/splash-source-black.png resources/icon.png
          cp public/splash-source-black.png resources/ios/splash.png
          echo "âœ… Imagens copiadas"
          ls -lh resources/

      - name: ğŸ¤– Generate Android resources
        run: |
          echo "ğŸ¤– Gerando resources Android..."
          cordova-res android --skip-config --copy
          echo "âœ… Android resources gerados"

      - name: ğŸ Generate iOS resources
        run: |
          echo "ğŸ Gerando resources iOS..."
          cordova-res ios --skip-config --copy
          echo "âœ… iOS resources gerados"

      - name: ğŸ—ï¸ Build project
        run: |
          echo "ğŸ—ï¸ Building project..."
          npm run build
          echo "âœ… Build concluÃ­do"

      - name: ğŸ”„ Sync Capacitor
        run: |
          echo "ğŸ”„ Syncing Capacitor..."
          npx cap sync android
          npx cap sync ios
          echo "âœ… Capacitor synced"

      - name: ğŸ“Š Show generated files
        run: |
          echo "ğŸ“Š Arquivos gerados:"
          echo ""
          echo "Android:"
          find android/app/src/main/res -name "*.png" | head -10
          echo ""
          echo "iOS:"
          find ios/App/App/Assets.xcassets -name "*.png" | head -10

      - name: ğŸ’¾ Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: auto-generate mobile resources [skip ci]'
          file_pattern: |
            android/app/src/main/res/**
            ios/App/App/Assets.xcassets/**
            resources/**
          commit_user_name: Shape Pro Bot
          commit_user_email: bot@shapepro.app
          commit_author: Shape Pro Bot <bot@shapepro.app>

      - name: âœ… Success notification
        if: success()
        run: |
          echo "ğŸ‰ Resources gerados e commitados com sucesso!"
          echo "ğŸ“± PrÃ³ximos passos:"
          echo "   1. git pull origin main"
          echo "   2. npx cap run android (ou ios)"

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Falha ao gerar resources"
          echo "Verifique os logs acima para mais detalhes"
